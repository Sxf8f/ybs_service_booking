{% extends "admin_dashboard.html" %}
{% load static %}

{% block title %}Upload EC{% endblock %}

{% block content %}
<div class="modern-container">
    <!-- Page Header -->
    <div class="modern-page-header">
        <h1 class="modern-page-title">Upload EC Recharge</h1>
        <div class="modern-breadcrumb">
            <a href="{% url 'dashboard' %}">Dashboard</a>
            <span class="breadcrumb-separator">/</span>
            <span>Upload EC</span>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="modern-alert modern-alert-{{ message.tags }}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    {% if message.tags == 'success' %}
                        <polyline points="20 6 9 17 4 12"></polyline>
                    {% elif message.tags == 'error' or message.tags == 'danger' %}
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    {% else %}
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    {% endif %}
                </svg>
                <div>{{ message }}</div>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" id="quickEntryForm" class="modern-form" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Step 1: Hierarchy Selection -->
        <div class="modern-card">
            <div class="card-header-modern">
                <h3>Step 1: Select Hierarchy</h3>
                <span class="modern-badge modern-badge-primary">Required</span>
            </div>

            <div class="form-row">
                {% if user_role == 'admin' %}
                <!-- Admin: Supervisor → Operator → FOS -->
                <div class="form-col-3">
                    <div class="modern-form-group">
                        <label for="supervisor" class="modern-label">
                            Supervisor (Sales) <span class="required-mark">*</span>
                        </label>
                        <select name="supervisor" id="supervisor" class="modern-input" required>
                            <option value="">Select Supervisor</option>
                            {% for sup in supervisors %}
                                <option value="{{ sup.id }}">{{ sup.name }} ({{ sup.supervisor_category.name }})</option>
                            {% endfor %}
                        </select>
                        <div id="supervisor-loading" class="loading-indicator" style="display: none;">
                            Loading supervisors...
                        </div>
                    </div>
                </div>
                <div class="form-col-3">
                    <div class="modern-form-group">
                        <label for="operator" class="modern-label">
                            Operator <span class="required-mark">*</span>
                        </label>
                        <select name="operator" id="operator" class="modern-input" required disabled>
                            <option value="">Select supervisor first</option>
                        </select>
                        <div id="operator-loading" class="loading-indicator" style="display: none;">
                            Loading operators...
                        </div>
                    </div>
                </div>
                <div class="form-col-3">
                    <div class="modern-form-group">
                        <label for="fos" class="modern-label">
                            FOS <span class="required-mark">*</span>
                        </label>
                        <select name="fos" id="fos" class="modern-input" required disabled>
                            <option value="">Select operator first</option>
                        </select>
                        <div id="fos-loading" class="loading-indicator" style="display: none;">
                            Loading FOS...
                        </div>
                    </div>
                </div>
                {% elif user_role == 'supervisor' %}
                <!-- Supervisor: Operator → FOS -->
                <div class="form-col-3">
                    <div class="modern-form-group">
                        <label for="operator" class="modern-label">
                            Operator <span class="required-mark">*</span>
                        </label>
                        <select name="operator" id="operator" class="modern-input" required data-supervisor-id="{{ user.id }}">
                            <option value="">Select Operator</option>
                            {% for op in operators %}
                                <option value="{{ op.id }}">{{ op.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-col-3">
                    <div class="modern-form-group">
                        <label for="fos" class="modern-label">
                            FOS <span class="required-mark">*</span>
                        </label>
                        <select name="fos" id="fos" class="modern-input" required>
                            <option value="">Select FOS</option>
                            {% if fos_users %}
                                {% for fos_user in fos_users %}
                                    <option value="{{ fos_user.id }}">{{ fos_user.name }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        <div id="fos-loading" class="loading-indicator" style="display: none;">
                            Loading FOS...
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- FOS Role: Operator selection only -->
                <div class="form-col-3">
                    <div class="modern-form-group">
                        <label for="operator" class="modern-label">
                            Operator <span class="required-mark">*</span>
                        </label>
                        <select name="operator" id="operator" class="modern-input" required>
                            <option value="">Select Operator</option>
                            {% for op in operators %}
                                <option value="{{ op.id }}">{{ op.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% endif %}

                <!-- Info Message for FOS Users -->
                {% if user_role == 'fos' %}
                <div class="form-col-2">
                    <div class="modern-alert modern-alert-info" style="margin-top: 0;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <div>You are uploading as <strong>{{ user.name }}</strong> (FOS)</div>
                    </div>
                </div>
                {% elif user_role == 'supervisor' %}
                <div class="form-col-1">
                    <div class="modern-alert modern-alert-info" style="margin-top: 0;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <div>You are uploading as <strong>{{ user.name }}</strong> (Supervisor)</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Step 2: Choose Entry Method -->
        <div class="modern-card">
            <div class="card-header-modern">
                <h3>Step 2: Choose Entry Method</h3>
            </div>
            <div class="form-row">
                <div class="form-col-1">
                    <div class="modern-form-group">
                        <label class="modern-label">Entry Type</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="entry_type" value="manual" checked onchange="toggleEntryType()" style="margin-right: 0.5rem;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                                Manual Entry (Multiple Rows)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="entry_type" value="excel" onchange="toggleEntryType()" style="margin-right: 0.5rem;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                Excel Upload (Bulk)
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Entry Section -->
        <div class="modern-card" id="manualEntrySection">
            <div class="card-header-modern">
                <h3>Step 3: Enter EC Recharge Details</h3>
                <button type="button" onclick="addRow()" class="modern-btn modern-btn-sm modern-btn-success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Row
                </button>
            </div>

            <div class="modern-table-container">
                <table class="modern-table" id="entryTable">
                    <thead>
                        <tr>
                            <th style="min-width: 120px;">Order ID *</th>
                            <th style="min-width: 130px;">Order Date *</th>
                            <th style="min-width: 120px;">Partner ID</th>
                            <th style="min-width: 150px;">Partner Name</th>
                            <th style="min-width: 130px;">Transfer Amount</th>
                            <th style="min-width: 120px;">Commission</th>
                            <th style="min-width: 150px;">Amount (W/O Comm.)</th>
                            <th style="width: 60px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="entryBody">
                        <tr>
                            <td><input type="text" name="order_id[]" class="modern-input manual-required" required></td>
                            <td><input type="date" name="order_date[]" class="modern-input manual-required" required></td>
                            <td><input type="text" name="partner_id[]" class="modern-input"></td>
                            <td><input type="text" name="partner_name[]" class="modern-input"></td>
                            <td><input type="number" name="transfer_amount[]" step="0.01" class="modern-input transfer-amount"></td>
                            <td><input type="number" name="commission[]" step="0.01" class="modern-input commission"></td>
                            <td><input type="number" name="amount_without_commission[]" step="0.01" class="modern-input amount-without-commission" readonly></td>
                            <td>
                                <button type="button" onclick="removeRow(this)" class="modern-btn modern-btn-sm modern-btn-danger" style="padding: 0.25rem 0.5rem;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="modern-alert modern-alert-info" style="margin-top: 1rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <div>
                    <strong>Tips:</strong>
                    <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                        <li>Amount Without Commission is auto-calculated (Transfer Amount - Commission)</li>
                        <li>Click "Add Row" to add more entries</li>
                        <li>All entries will be saved together when you click "Save All Entries"</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Excel Upload Section -->
        <div class="modern-card" id="excelUploadSection" style="display: none;">
            <div class="card-header-modern">
                <h3>Step 3: Upload Excel File</h3>
            </div>

            <div class="modern-form-group">
                <label for="excel_file" class="modern-label">
                    Select Excel File <span class="required-mark">*</span>
                </label>
                <div class="file-upload-wrapper">
                    <div class="file-upload-input">
                        <input type="file" name="excel_file" id="excel_file" accept=".xlsx,.xls" class="modern-input">
                        <label for="excel_file" class="file-upload-label">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span class="file-name-excel">Choose file...</span>
                        </label>
                    </div>
                </div>
                <div class="form-hint">Accepted formats: .xlsx, .xls (Max size: 10MB)</div>
            </div>

            <div class="modern-alert modern-alert-info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <div>
                    <strong>Excel File Format:</strong> Your Excel file must have these columns in order:
                    <ol style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                        <li>Order ID</li>
                        <li>Order Date (DD.MM.YYYY or YYYY-MM-DD)</li>
                        <li>Partner ID</li>
                        <li>Partner Name (must match retailer name exactly)</li>
                        <li>Transfer Amount</li>
                        <li>Commission</li>
                        <li>Amount Without Commission</li>
                    </ol>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                <a href="{% url 'ec_sample_excel' %}" class="modern-btn modern-btn-outline" download>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Download Sample Excel
                </a>
            </div>
        </div>

        <!-- Submit Actions -->
        <div class="form-actions-modern">
            <button type="submit" class="modern-btn modern-btn-primary modern-btn-lg" id="submitBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Save All Entries (<span id="row-count">1</span> rows)
            </button>
            <a href="{% url 'dashboard' %}" class="modern-btn modern-btn-outline">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const role = '{{ user_role }}';
    const operatorSelect = document.getElementById('operator');
    const supervisorSelect = document.getElementById('supervisor');
    const fosSelect = document.getElementById('fos');
    const operatorLoading = document.getElementById('operator-loading');
    const fosLoading = document.getElementById('fos-loading');

    function resetSelect(selectElement, placeholderText, disable = true) {
        if (!selectElement) return;
        selectElement.innerHTML = `<option value="">${placeholderText}</option>`;
        selectElement.disabled = disable;
    }

    if (supervisorSelect && operatorSelect) {
        supervisorSelect.addEventListener('change', function() {
            const supervisorId = this.value;
            resetSelect(operatorSelect, 'Select supervisor first');
            resetSelect(fosSelect, 'Select operator first');

            if (!supervisorId) {
                return;
            }

            if (operatorLoading) {
                operatorLoading.style.display = 'block';
            }

            fetch(`{% url 'ec_get_operators' %}?supervisor_id=${supervisorId}`)
                .then(response => response.json())
                .then(data => {
                    if (operatorLoading) {
                        operatorLoading.style.display = 'none';
                    }
                    if (data.operators && data.operators.length > 0) {
                        operatorSelect.disabled = false;
                        operatorSelect.innerHTML = '<option value="">Select Operator</option>';
                        data.operators.forEach(op => {
                            const option = document.createElement('option');
                            option.value = op.id;
                            option.textContent = op.name;
                            operatorSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    if (operatorLoading) {
                        operatorLoading.style.display = 'none';
                    }
                    console.error('Error loading operators:', error);
                });
        });
    }

    if (operatorSelect && fosSelect) {
        operatorSelect.addEventListener('change', function() {
            const operatorId = this.value;
            let supervisorId = null;

            if (role === 'admin') {
                supervisorId = supervisorSelect ? supervisorSelect.value : null;
            } else if (role === 'supervisor') {
                supervisorId = this.dataset.supervisorId || null;
            }

            resetSelect(fosSelect, role === 'admin' ? 'Select operator first' : 'Select FOS', true);

            if (!operatorId || !supervisorId) {
                return;
            }

            if (fosLoading) {
                fosLoading.style.display = 'block';
            }

            fetch(`{% url 'ec_get_fos' %}?operator_id=${operatorId}&supervisor_id=${supervisorId}`)
                .then(response => response.json())
                .then(data => {
                    if (fosLoading) {
                        fosLoading.style.display = 'none';
                    }
                    if (data.fos_list && data.fos_list.length > 0) {
                        fosSelect.disabled = false;
                        fosSelect.innerHTML = '<option value="">Select FOS</option>';
                        data.fos_list.forEach(fos => {
                            const option = document.createElement('option');
                            option.value = fos.id;
                            option.textContent = fos.name;
                            fosSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    if (fosLoading) {
                        fosLoading.style.display = 'none';
                    }
                    console.error('Error loading FOS:', error);
                });
        });
    }

    // Auto-calculate amount without commission
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('transfer-amount') || e.target.classList.contains('commission')) {
            const row = e.target.closest('tr');
            const transferAmount = parseFloat(row.querySelector('.transfer-amount').value) || 0;
            const commission = parseFloat(row.querySelector('.commission').value) || 0;
            const amountWithoutCommission = transferAmount - commission;
            row.querySelector('.amount-without-commission').value = amountWithoutCommission.toFixed(2);
        }
    });

    // Update row count
    updateRowCount();
    setManualRequired(true);

    // File input handler for Excel
    const excelFileInput = document.getElementById('excel_file');
    const fileNameSpan = document.querySelector('.file-name-excel');
    if (excelFileInput && fileNameSpan) {
        excelFileInput.addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Choose file...';
            fileNameSpan.textContent = fileName;
        });
    }

    // Update form enctype when Excel is selected
    const form = document.getElementById('quickEntryForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const entryType = document.querySelector('input[name="entry_type"]:checked').value;
            if (entryType === 'excel') {
                form.enctype = 'multipart/form-data';
            }
        });
    }
});

function toggleEntryType() {
    const entryType = document.querySelector('input[name="entry_type"]:checked').value;
    const manualSection = document.getElementById('manualEntrySection');
    const excelSection = document.getElementById('excelUploadSection');
    const submitBtn = document.getElementById('submitBtn');
    const rowCountSpan = document.getElementById('row-count');

    if (entryType === 'manual') {
        manualSection.style.display = 'block';
        excelSection.style.display = 'none';
        setManualRequired(true);
        submitBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Save All Entries (<span id="row-count">${rowCountSpan ? rowCountSpan.textContent : '1'}</span> rows)
        `;
    } else {
        manualSection.style.display = 'none';
        excelSection.style.display = 'block';
        setManualRequired(false);
        submitBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Upload & Process Excel
        `;
    }
}

function addRow() {
    const tbody = document.getElementById('entryBody');
    const newRow = tbody.rows[0].cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => {
        input.value = '';
        if (input.classList.contains('amount-without-commission')) {
            input.value = '0.00';
        }
    });
    tbody.appendChild(newRow);
    updateRowCount();
    setManualRequired(document.querySelector('input[name="entry_type"]:checked').value === 'manual');
}

function removeRow(btn) {
    const tbody = document.getElementById('entryBody');
    if (tbody.rows.length > 1) {
        btn.closest('tr').remove();
        updateRowCount();
    }
}

function updateRowCount() {
    const tbody = document.getElementById('entryBody');
    document.getElementById('row-count').textContent = tbody.rows.length;
}

function setManualRequired(enable) {
    document.querySelectorAll('.manual-required').forEach(input => {
        if (enable) {
            input.setAttribute('required', 'required');
        } else {
            input.removeAttribute('required');
        }
    });
}
</script>

<style>
.loading-indicator {
    font-size: 0.875rem;
    color: var(--info-color);
    margin-top: 0.25rem;
}

#entryTable input {
    width: 100%;
    min-width: 100px;
}

#entryTable td {
    padding: 0.5rem;
}
</style>
{% endblock %}
